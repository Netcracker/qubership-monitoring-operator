name: Alerts-test-qubership-monitoring-operator
on:
  workflow_run:
    workflows: ["Build Artifacts"]
    types:
      - completed
  pull_request:
    branches:
      - all

env:
  kind_name: kind-cluster
  kind_version: v0.27.0
  vm_namespace: vm
  max_attempts: 30
  delay: 10

jobs:
  Run-Alerts-Test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Check yq version
        run: yq --version

      - name: Set up Kind
        run: |
          curl -sLo ./kind https://kind.sigs.k8s.io/dl/${{ env.kind_version }}/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/
          kind delete cluster --name ${{ env.kind_name }}
          cat <<EOF | kind create cluster --config=-
          kind: Cluster
          name:  ${{ env.kind_name }}
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            extraPortMappings:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - containerPort: 443
              hostPort: 443
              protocol: TCP
          EOF

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Render rules file from helm chart
        run: |
          helm template alertrules ./charts/qubership-monitoring-operator/charts/qubership-monitoring-configuration > ./test/alerts-tests/rules.yaml
          sed '1,7d' -i ./test/alerts-tests/rules.yaml

      - name: Check that all necessary tests exists
        run: |
          chmod +x ./test/alerts-tests/tests-checker.sh
          cd ./test/alerts-tests/
          ./tests-checker.sh       
        continue-on-error: true

      - name: Install vmalert-tool
        run: |
          wget https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.122.4/vmutils-linux-amd64-v1.122.4-enterprise.tar.gz
          tar -xvf vmutils-linux-amd64-v1.122.4-enterprise.tar.gz
          chmod +x vmalert-tool-prod

      - name: Run test
        run: |
          ./vmalert-tool-prod unittest --files ./test/alerts-tests/test.yaml