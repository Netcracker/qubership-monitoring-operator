# This workflow handles Go builds with optional Sonar analysis.
# It can be called from other workflows and supports different build modes based on:
# - Actor type (bot or user)
#
# Build steps:
#  - Automatically detects Go module location using go.mod file
#  - Runs tests with coverage
#  - Sonar analysis (if not skipped for restricted actors)
#
# Sonar analysis:
# - Only runs if both sonar-project-key and sonar-token are provided
# - Always skipped for restricted actors
# - Requires proper Sonar configuration (organization, host URL, etc.)
#
# Restricted actors:
# - Defined in .github/config/build-config.yaml
# - Cannot run Sonar analysis
#
# Working directory:
# - Automatically detected based on go.mod file location
# - All Go commands are executed in the directory containing go.modname: Go unit tests
name: Go test with Sonar
on:
  pull_request:
    types: [ opened, synchronize, reopened ]
  push:
    branches:
      - '**'
permissions:
  contents: read


jobs:
  test:
    uses: beauline/qubership-core-infra/.github/workflows/go-build-with-sonar.yaml@feat/envtest-in-go-build-with-sonar
    with:
      actor: ${{ github.actor }}
      sonar-project-key: ${{ vars.SONAR_PROJECT_KEY || '' }}
      go-module-dir: '.'
    secrets:
      sonar-token: ${{ secrets.SONAR_TOKEN || '' }}
 