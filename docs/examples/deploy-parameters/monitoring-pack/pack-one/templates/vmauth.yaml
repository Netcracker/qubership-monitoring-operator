{{- $vmAuthValues := .Values.vmAuth | default dict }}
{{- $vmAuthSpec := $vmAuthValues.spec | default dict }}
{{- if $vmAuthValues.install }}
{{- $namespace := include "monitoring-pack-one.namespace" . }}
{{- $vmAuthName := default (printf "%s-vmauth" (include "monitoring-pack-one.fullname" .)) $vmAuthValues.name }}
{{- $defaultUserSelector := dict "matchLabels" (dict "app.kubernetes.io/name" "vmuser") }}
{{- $userSelector := default $defaultUserSelector $vmAuthSpec.userSelector }}
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAuth
metadata:
  labels:
    name: vmauth
    app.kubernetes.io/name: vmauth
    app.kubernetes.io/component: victoriametrics
    app.kubernetes.io/part-of: monitoring
    app.kubernetes.io/managed-by: monitoring-operator
    {{- $labelCtx := dict "commonLabels" .Values.commonLabels "componentLabels" .Values.vmAuth.labels }}
    {{- include "monitoring-pack-one.metadata.labels" $labelCtx | nindent 4 }}
  name: {{ $vmAuthName }}
  namespace: {{ $namespace }}
  {{- $annotationCtx := dict "commonAnnotations" .Values.commonAnnotations "componentAnnotations" .Values.vmAuth.annotations }}
  {{- include "monitoring-pack-one.metadata.annotations" $annotationCtx | nindent 2 }}
spec:
  replicaCount: {{ default 1 $vmAuthSpec.replicaCount }}
  resources: {{ toYaml ($vmAuthSpec.resources | default dict) | nindent 4 }}
  securityContext:
    runAsUser: 2000
    runAsGroup: 2000
    fsGroup: 2000

  # Enable discovery all CRs if labelSelectors is empty
  selectAllByDefault: {{ default false $vmAuthSpec.selectAllByDefault }}

  # Selector to discovery CRs
  userSelector: {{ toYaml $userSelector | nindent 4 }}
  userNamespaceSelector: {{ toYaml ($vmAuthSpec.userNamespaceSelector | default dict) | nindent 4 }}

  {{- if $vmAuthSpec.port }}
  port: {{ $vmAuthSpec.port | quote }}
  {{- end }}

  {{- if $vmAuthSpec.extraArgs }}
  extraArgs: {{ toYaml $vmAuthSpec.extraArgs | nindent 4 }}
  {{- end }}

  {{- if $vmAuthSpec.extraEnvs }}
  extraEnvs: {{ toYaml $vmAuthSpec.extraEnvs | nindent 4 }}
  {{- end }}
{{- end }}
