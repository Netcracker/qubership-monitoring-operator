{{- if and .Values.vmAuth.install .Values.ingress.install }}
{{- if .Values.ingress.vmAuth }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ default (printf "%s-vmauth" (include "monitoring-pack-two.fullname" .)) .Values.vmAuth.name }}-ingress
  namespace: {{ include "monitoring-pack-two.namespace" . }}
  labels:
    name: vmauth-ingress
    app.kubernetes.io/name: vmauth
    app.kubernetes.io/component: ingress
    app.kubernetes.io/part-of: monitoring
    app.kubernetes.io/managed-by: monitoring-operator
    monitoring-pack: "two"
    {{- $labelCtx := dict "commonLabels" .Values.commonLabels "componentLabels" (.Values.ingress.vmAuth.labels | default dict) }}
    {{- include "monitoring-pack-two.metadata.labels" $labelCtx | nindent 4 }}
  annotations:
    {{- $annotationCtx := dict "commonAnnotations" .Values.commonAnnotations "componentAnnotations" (.Values.ingress.vmAuth.annotations | default dict) }}
    {{- include "monitoring-pack-two.metadata.annotations" $annotationCtx | nindent 4 }}
spec:
  {{- if .Values.ingress.vmAuth.ingressClassName }}
  ingressClassName: {{ .Values.ingress.vmAuth.ingressClassName }}
  {{- end }}
  rules:
    - host: {{ .Values.ingress.vmAuth.host }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                # VictoriaMetrics Operator creates service as vmauth-{name}, not {name}-vmauth
                name: vmauth-{{ default (printf "%s-vmauth" (include "monitoring-pack-two.fullname" .)) .Values.vmAuth.name }}
                port:
                  number: {{ .Values.ingress.vmAuth.servicePort | default 8427 }}
  {{- if .Values.ingress.vmAuth.tlsSecretName }}
  tls:
    - hosts:
        - {{ .Values.ingress.vmAuth.host }}
      secretName: {{ .Values.ingress.vmAuth.tlsSecretName }}
  {{- end }}
{{- end }}
{{- end }}

{{- if and .Values.vmAgent.install .Values.vmAuth.install .Values.ingress.install }}
{{- if .Values.ingress.vmAgent }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ default (printf "%s-vmagent" (include "monitoring-pack-two.fullname" .)) .Values.vmAgent.name }}-ingress
  namespace: {{ include "monitoring-pack-two.namespace" . }}
  labels:
    name: vmagent-ingress
    app.kubernetes.io/name: vmagent
    app.kubernetes.io/component: ingress
    app.kubernetes.io/part-of: monitoring
    app.kubernetes.io/managed-by: monitoring-operator
    monitoring-pack: "two"
    {{- $labelCtx := dict "commonLabels" .Values.commonLabels "componentLabels" (.Values.ingress.vmAgent.labels | default dict) }}
    {{- include "monitoring-pack-two.metadata.labels" $labelCtx | nindent 4 }}
  annotations:
    {{- $annotationCtx := dict "commonAnnotations" .Values.commonAnnotations "componentAnnotations" (.Values.ingress.vmAgent.annotations | default dict) }}
    {{- include "monitoring-pack-two.metadata.annotations" $annotationCtx | nindent 4 }}
spec:
  {{- if .Values.ingress.vmAgent.ingressClassName }}
  ingressClassName: {{ .Values.ingress.vmAgent.ingressClassName }}
  {{- end }}
  rules:
    - host: {{ .Values.ingress.vmAgent.host }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                # Route through VMAuth for authentication
                # VictoriaMetrics Operator creates service as vmauth-{name}, not {name}-vmauth
                name: vmauth-{{ default (printf "%s-vmauth" (include "monitoring-pack-two.fullname" .)) .Values.vmAuth.name }}
                port:
                  number: {{ .Values.ingress.vmAuth.servicePort | default 8427 }}
  {{- if .Values.ingress.vmAgent.tlsSecretName }}
  tls:
    - hosts:
        - {{ .Values.ingress.vmAgent.host }}
      secretName: {{ .Values.ingress.vmAgent.tlsSecretName }}
  {{- end }}
{{- end }}
{{- end }}

{{- if and .Values.vmSingle.install .Values.vmAuth.install .Values.ingress.install }}
{{- if .Values.ingress.vmSingle }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Values.vmSingle.name }}-ingress
  namespace: {{ include "monitoring-pack-two.namespace" . }}
  labels:
    name: vmsingle-ingress
    app.kubernetes.io/name: vmsingle
    app.kubernetes.io/component: ingress
    app.kubernetes.io/part-of: monitoring
    app.kubernetes.io/managed-by: monitoring-operator
    monitoring-pack: "two"
    {{- $labelCtx := dict "commonLabels" .Values.commonLabels "componentLabels" (.Values.ingress.vmSingle.labels | default dict) }}
    {{- include "monitoring-pack-two.metadata.labels" $labelCtx | nindent 4 }}
  annotations:
    {{- $annotationCtx := dict "commonAnnotations" .Values.commonAnnotations "componentAnnotations" (.Values.ingress.vmSingle.annotations | default dict) }}
    {{- include "monitoring-pack-two.metadata.annotations" $annotationCtx | nindent 4 }}
spec:
  {{- if .Values.ingress.vmSingle.ingressClassName }}
  ingressClassName: {{ .Values.ingress.vmSingle.ingressClassName }}
  {{- end }}
  rules:
    - host: {{ .Values.ingress.vmSingle.host }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                # Route through VMAuth for authentication
                # VictoriaMetrics Operator creates service as vmauth-{name}, not {name}-vmauth
                name: vmauth-{{ default (printf "%s-vmauth" (include "monitoring-pack-two.fullname" .)) .Values.vmAuth.name }}
                port:
                  number: {{ .Values.ingress.vmAuth.servicePort | default 8427 }}
  {{- if .Values.ingress.vmSingle.tlsSecretName }}
  tls:
    - hosts:
        - {{ .Values.ingress.vmSingle.host }}
      secretName: {{ .Values.ingress.vmSingle.tlsSecretName }}
  {{- end }}
{{- end }}
{{- end }}

{{- if and .Values.grafana.install .Values.ingress.install }}
{{- if .Values.ingress.grafana }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ default (printf "%s-grafana" (include "monitoring-pack-two.fullname" .)) .Values.grafana.name }}-ingress
  namespace: {{ include "monitoring-pack-two.namespace" . }}
  labels:
    name: grafana-ingress
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: ingress
    app.kubernetes.io/part-of: monitoring
    app.kubernetes.io/managed-by: monitoring-operator
    monitoring-pack: "two"
    {{- $labelCtx := dict "commonLabels" .Values.commonLabels "componentLabels" (.Values.ingress.grafana.labels | default dict) }}
    {{- include "monitoring-pack-two.metadata.labels" $labelCtx | nindent 4 }}
  annotations:
    {{- $annotationCtx := dict "commonAnnotations" .Values.commonAnnotations "componentAnnotations" (.Values.ingress.grafana.annotations | default dict) }}
    {{- include "monitoring-pack-two.metadata.annotations" $annotationCtx | nindent 4 }}
spec:
  {{- if .Values.ingress.grafana.ingressClassName }}
  ingressClassName: {{ .Values.ingress.grafana.ingressClassName }}
  {{- end }}
  rules:
    - host: {{ .Values.ingress.grafana.host }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                # Grafana Operator creates service as {grafana-cr-name}-service
                name: {{ default (printf "%s-grafana" (include "monitoring-pack-two.fullname" .)) .Values.grafana.name }}-service
                port:
                  number: {{ .Values.ingress.grafana.servicePort | default 3000 }}
  {{- if .Values.ingress.grafana.tlsSecretName }}
  tls:
    - hosts:
        - {{ .Values.ingress.grafana.host }}
      secretName: {{ .Values.ingress.grafana.tlsSecretName }}
  {{- end }}
{{- end }}
{{- end }}
